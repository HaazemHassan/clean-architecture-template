# Authorization System - ???? ?????????

## ?? ???? ????

?? ????? ??? `AuthorizationBehavior` ????? ????? ????? ?? Authorization:

### 1. **Role-Based Authorization** ??
?????? ?? ?? ???????? ???? Role ????

### 2. **Permission-Based Authorization** ??
?????? ?? ?? ???????? ???? Permissions ?????

### 3. **Policy-Based Authorization** ??
????? ????? ????? (???: SelfOrAdmin)

---

## ?? ????? ?????????

### ???? 1: Role-Based Authorization
```csharp
using Template.Application.Common.Security;
using Template.Domain.Enums;

[Authorize(Roles = new[] { UserRole.Admin, UserRole.SuperAdmin })]
public class DeleteUserCommand : IRequest<ServiceOperationResult>
{
    public int UserId { get; set; }
}
```

### ???? 2: Permission-Based Authorization
```csharp
[Authorize(Permissions = new[] { Permission.UsersWrite, Permission.UsersDelete })]
public class BulkDeleteUsersCommand : IRequest<ServiceOperationResult>
{
    public List<int> UserIds { get; set; }
}
```

### ???? 3: Policy-Based Authorization
```csharp
[Authorize(Policy = AuthorizationPolicies.SelfOrAdmin)]
public class UpdateUserProfileCommand : IRequest<ServiceOperationResult<UserDto>>
{
    public int UserId { get; set; }  // ? ???! ??? Policy ?????? ?? ??
    public string FirstName { get; set; }
    public string LastName { get; set; }
}
```

### ???? 4: ??? ???? ?? ???
```csharp
[Authorize(Roles = new[] { UserRole.Manager }, Permissions = new[] { Permission.ReportsRead })]
[Authorize(Policy = AuthorizationPolicies.SelfOrAdmin)]  // ???? ??????? ???? ?? Attribute
public class ViewSensitiveReportCommand : IRequest<ServiceOperationResult<Report>>
{
    public int UserId { get; set; }
}
```

---

## ?? Authorization Policies ???????

?? ????? class `AuthorizationPolicies` ????? ??? constants ??? policies:

```csharp
namespace Template.Application.Common.Security
{
    public static class AuthorizationPolicies
    {
        public const string SelfOrAdmin = nameof(SelfOrAdmin);
        public const string OnlyOwner = nameof(OnlyOwner);
        public const string TeamMember = nameof(TeamMember);
        public const string ManagerOrAbove = nameof(ManagerOrAbove);
    }
}
```

### ?????? Constants ????? ?? Hardcoded Strings:
```csharp
// ? ??
[Authorize(Policy = AuthorizationPolicies.SelfOrAdmin)]

// ? ???
[Authorize(Policy = "SelfOrAdmin")]
```

---

## ??? ????? Policy ????

### ?????? 1: ??? ??? Constant ?? AuthorizationPolicies

```csharp
// ?? src\Template.Application\Common\Security\AuthorizationPolicies.cs

public static class AuthorizationPolicies
{
    public const string SelfOrAdmin = nameof(SelfOrAdmin);
    public const string OnlyOwner = nameof(OnlyOwner);  // ? ????
}
```

### ?????? 2: ??? ??? Policy ?? PolicyEnforcer

```csharp
// ?? src\Template.Infrastructure\Services\PolicyEnforcer.cs

public async Task<ServiceOperationResult<bool>> AuthorizeAsync<TRequest>(
    TRequest request, Guid userId, string policyName, CancellationToken cancellationToken)
{
    return policyName switch
    {
        AuthorizationPolicies.SelfOrAdmin => await SelfOrAdminPolicy(request, userId),
        AuthorizationPolicies.OnlyOwner => await OnlyOwnerPolicy(request, userId),  // ? ????
        _ => ServiceOperationResult<bool>.Failure(
            ServiceOperationStatus.Failed,
            $"Unknown policy: {policyName}")
    };
}

// ????: Policy ?????? ?? ?? ???????? ?? ?????? ???
private async Task<ServiceOperationResult<bool>> OnlyOwnerPolicy<TRequest>(
    TRequest request, Guid userId)
{
    var ownerIdProperty = request?.GetType().GetProperty("OwnerId");
    var ownerId = ownerIdProperty?.GetValue(request);
    
    if (ownerId is null)
    {
        return ServiceOperationResult<bool>.Failure(
            ServiceOperationStatus.InvalidParameters,
            "Request does not contain OwnerId property");
    }
    
    var ownerIdInt = Convert.ToInt32(ownerId);
    var currentUserIdInt = int.Parse(userId.ToString());
    
    if (ownerIdInt == currentUserIdInt)
    {
        return ServiceOperationResult<bool>.Success(true);
    }
    
    return ServiceOperationResult<bool>.Failure(
        ServiceOperationStatus.Forbidden,
        "Only the owner can perform this action.");
}
```

### ?????? 3: ??????? ?? Command
```csharp
[Authorize(Policy = AuthorizationPolicies.OnlyOwner)]
public class DeleteProjectCommand : IRequest<ServiceOperationResult>
{
    public int ProjectId { get; set; }
    public int OwnerId { get; set; }  // ? ??? Policy ????? ?? ???
}
```

---

## ?? ????? ?? ???????

### 1. UpdateProfileCommand
```csharp
[Authorize(Policy = AuthorizationPolicies.SelfOrAdmin)]
public class UpdateProfileCommand : IRequest<Response<UpdateProfileCommandResponse>>
{
    public int UserId { get; set; }  // Used for authorization
    public string? FirstName { get; set; }
    public string? LastName { get; set; }
}
```
- ? User ???? ???? ???? ??????
- ? Admin ???? ???? ?? ???

### 2. AddUserCommand
```csharp
[Authorize(Permissions = new[] { Permission.UsersWrite })]
[Authorize(Roles = new[] { UserRole.Admin, UserRole.SuperAdmin })]
public class AddUserCommand : IRequest<Response<AddUserCommandResponse>>
{
    public string Email { get; set; }
    // ...
}
```
- ? ??? ?? ???? Admin OR SuperAdmin
- ? ???? ?? ???? ???? Permission.UsersWrite

### 3. ChangePasswordCommand
```csharp
// ?? ????? Authorization attribute
public class ChangePasswordCommand : IRequest<Result>
{
    public string CurrentPassword { get; set; }
    public string NewPassword { get; set; }
}
```
- ? User ???? ???? password ????? ??? (?? ???? CurrentUserService)

---

## ?? ??? ???? ???????

### 1. Request ???? ??????
```
HTTP Request ? Controller ? MediatR Pipeline ? AuthorizationBehavior
```

### 2. AuthorizationBehavior ????? ??:
```csharp
// ?. ?? ???????? ???? ?????
if (!currentUserService.IsAuthenticated)
    return "Unauthorized";

// ?. ?? ???? ??? Roles ?????????
if (attr.Roles.Any() && !hasRole)
    return "Forbidden - Missing Role";

// ?. ?? ???? ??? Permissions ?????????
if (attr.Permissions.Any() && !hasPermission)
    return "Forbidden - Missing Permission";

// ?. ?? ????? ???? ??? Policy?
if (!string.IsNullOrEmpty(attr.Policy) && !policyPassed)
    return "Forbidden - Policy Failed";
```

### 3. ??? ??? ? ???? ??? Command
```
AuthorizationBehavior ? ? ValidationBehavior ? Handler ? Database
```

---

## ?? ??????? ????

### 1. **??? Policy ????? ??? Properties ?? ??? Command**
```csharp
[Authorize(Policy = AuthorizationPolicies.SelfOrAdmin)]
public class UpdateProfileCommand {
    public int UserId { get; set; }  // ? Policy ????? ??? UserId ?? Id
}
```

### 2. **Multiple Attributes = AND Logic**
```csharp
[Authorize(Roles = new[] { UserRole.Admin })]
[Authorize(Permissions = new[] { Permission.UsersWrite })]
// ??????: ??? ?? ???? Admin AND ???? Permission
```

### 3. **Array ?? ??? ??? Attribute = OR Logic**
```csharp
[Authorize(Roles = new[] { UserRole.Admin, UserRole.Manager })]
// ??????: Admin OR Manager
```

### 4. **?????? Constants ??????**
```csharp
// ? ?? - Type-safe
[Authorize(Policy = AuthorizationPolicies.SelfOrAdmin)]

// ? ??? - ???? ???????
[Authorize(Policy = "SelfOrAdmin")]
```

---

## ?? ????? ??????

### ???? ????: Update User Profile

```csharp
// Command
[Authorize(Policy = AuthorizationPolicies.SelfOrAdmin)]
public class UpdateUserProfileCommand : IRequest<ServiceOperationResult<UserDto>>
{
    public int UserId { get; set; }
    public string FirstName { get; set; }
    public string Email { get; set; }
}

// Handler
public class UpdateUserProfileCommandHandler 
    : IRequestHandler<UpdateUserProfileCommand, ServiceOperationResult<UserDto>>
{
    public async Task<ServiceOperationResult<UserDto>> Handle(
        UpdateUserProfileCommand request, 
        CancellationToken cancellationToken)
    {
        // ??? Authorization ??? ?????? ?
        // ????? ????? ????? ?????
        
        var user = await _context.Users.FindAsync(request.UserId);
        user.FirstName = request.FirstName;
        user.Email = request.Email;
        
        await _context.SaveChangesAsync(cancellationToken);
        
        return ServiceOperationResult<UserDto>.Success(MapToDto(user));
    }
}
```

### ????????????:

1. **User ????? ????? ???? ?????? (UserId = 5):**
   - UserId ?? Request = 5
   - Current UserId = 5
   - Policy Result: ? **Allowed** (??? ????????)

2. **Admin ????? ????? ??? user ???:**
   - UserId ?? Request = 5
   - Current UserId = 1 (Admin)
   - Policy Result: ? **Allowed** (Admin)

3. **User ???? ????? ????? ??? user ???:**
   - UserId ?? Request = 5
   - Current UserId = 3 (??? Admin)
   - Policy Result: ? **Forbidden**

---

## ?? ???????

- ? **?? ?????** GetCustomAttributes
- ? **?? ?????** Roles check
- ? **?? ?????** ServiceOperationResult types
- ? **?? ?????** PolicyEnforcer parameters
- ? **?? ?????** AuthorizationPolicies constants class
- ? **?? ?????** Authorization ??? Commands ?? ???????
- ? ?????? ???? ???? ???? ????

**????? ???? ??? ????? ?????????!** ??
